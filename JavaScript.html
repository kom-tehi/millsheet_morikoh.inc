<script>
// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
let currentUser = {};
let currentFilter = {};
let allRecords = [];

// ============================================================
// ÂàùÊúüÂåñ
// ============================================================
window.onload = function() {
  loadUserInfo();
  loadMasterData();
  loadRecords();
  initDateFields();
};

function loadUserInfo() {
  google.script.run
    .withSuccessHandler(function(user) {
      currentUser = user;
      updateUIByRole();
    })
    .getUserInfo();
}

function updateUIByRole() {
  if (currentUser.role === 'viewer') {
    document.getElementById('btnCreate').style.display = 'none';
  }
}

function loadMasterData() {
  google.script.run
    .withSuccessHandler(function(options) {
      populateSelect('diameter', options);
      populateSelect('filterDiameter', options);
    })
    .getDiameterOptions();
  
  google.script.run
    .withSuccessHandler(function(options) {
      populateSelect('strength', options);
    })
    .getStrengthOptions();
}

function populateSelect(elementId, options) {
  const select = document.getElementById(elementId);
  const currentValue = select.value;
  
  // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥ÔºàÊúÄÂàù„ÅÆ„ÄåÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄçÁ≠âÔºâ„Çí‰øùÊåÅ
  const firstOption = select.options[0];
  select.innerHTML = '';
  select.appendChild(firstOption);
  
  options.forEach(opt => {
    const option = document.createElement('option');
    option.value = opt;
    option.textContent = opt;
    select.appendChild(option);
  });
  
  if (currentValue) {
    select.value = currentValue;
  }
}

function initDateFields() {
  const today = new Date().toISOString().split('T')[0];
  const summaryYear = new Date().getFullYear();
  const summaryMonth = new Date().getMonth() + 1;
  
  document.getElementById('summaryYear').value = summaryYear;
  document.getElementById('summaryMonth').value = summaryMonth;
}

// ============================================================
// „Éá„Éº„ÇøË™≠„ÅøËæº„Åø„ÉªË°®Á§∫
// ============================================================
function loadRecords() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(records) {
      allRecords = records;
      displayRecords(records);
      hideLoading();
    })
    .withFailureHandler(function(error) {
      alert('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº: ' + error);
      hideLoading();
    })
    .getAllRecords(currentFilter);
}

function displayRecords(records) {
  const tbody = document.getElementById('recordTableBody');
  tbody.innerHTML = '';
  
  if (records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 40px; color: #999;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>';
    return;
  }
  
  records.forEach(record => {
    const row = tbody.insertRow();
    
    row.insertCell().textContent = record.arrivalDate;
    row.insertCell().textContent = record.deliveryNo;
    row.insertCell().textContent = record.contractNo;
    row.insertCell().textContent = record.diameter;
    row.insertCell().textContent = record.quantity.toFixed(3);
    
    // „Çπ„ÉÜ„Éº„Çø„Çπ
    const statusCell = row.insertCell();
    const statusBadge = document.createElement('span');
    statusBadge.className = 'status-badge ' + 
      (record.submitStatus === 'submitted' ? 'status-submitted' : 'status-unsubmitted');
    statusBadge.textContent = record.submitStatus === 'submitted' ? 'ÊèêÂá∫Ê∏à' : 'Êú™ÊèêÂá∫';
    statusCell.appendChild(statusBadge);
    
    // ÊèêÂá∫Êó•
    row.insertCell().textContent = record.millSentDate || '-';
    row.insertCell().textContent = record.pdfSentDate || '-';
    row.insertCell().textContent = record.netSentDate || '-';
    
    // Ê∑ª‰ªò
    const attachCell = row.insertCell();
    if (record.attachUrl || record.attachFileId) {
      const link = document.createElement('a');
      link.href = record.attachUrl || `https://drive.google.com/file/d/${record.attachFileId}/view`;
      link.target = '_blank';
      link.textContent = 'üìé';
      link.style.fontSize = '18px';
      attachCell.appendChild(link);
    } else {
      attachCell.textContent = '-';
    }
    
    // Êìç‰Ωú„Éú„Çø„É≥
    const actionCell = row.insertCell();
    const actionGroup = document.createElement('div');
    actionGroup.className = 'action-group';
    
    // ÊèêÂá∫Ê∏à„Éú„Çø„É≥
    if (record.submitStatus === 'unsubmitted' && currentUser.role !== 'viewer') {
      const submitBtn = document.createElement('button');
      submitBtn.className = 'btn-success';
      submitBtn.textContent = '‚úì';
      submitBtn.title = 'ÊèêÂá∫Ê∏à„Å´„Åô„Çã';
      submitBtn.onclick = () => markAsSubmitted(record.id);
      actionGroup.appendChild(submitBtn);
    }
    
    // Êú™ÊèêÂá∫„Å´Êàª„Åô„Éú„Çø„É≥ÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ
    if (record.submitStatus === 'submitted' && currentUser.role === 'admin') {
      const unsubmitBtn = document.createElement('button');
      unsubmitBtn.className = 'btn-warning';
      unsubmitBtn.textContent = '‚Ü©';
      unsubmitBtn.title = 'Êú™ÊèêÂá∫„Å´Êàª„Åô';
      unsubmitBtn.onclick = () => markAsUnsubmitted(record.id);
      actionGroup.appendChild(unsubmitBtn);
    }
    
    // Á∑®ÈõÜ„Éú„Çø„É≥
    if (currentUser.role !== 'viewer') {
      const editBtn = document.createElement('button');
      editBtn.className = 'btn-info';
      editBtn.textContent = '‚úé';
      editBtn.title = 'Á∑®ÈõÜ';
      editBtn.onclick = () => showEditModal(record);
      actionGroup.appendChild(editBtn);
    }
    
    // ÂâäÈô§„Éú„Çø„É≥ÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ
    if (currentUser.role === 'admin') {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn-danger';
      deleteBtn.textContent = '√ó';
      deleteBtn.title = 'ÂâäÈô§';
      deleteBtn.onclick = () => deleteRecord(record.id);
      actionGroup.appendChild(deleteBtn);
    }
    
    actionCell.appendChild(actionGroup);
  });
}

// ============================================================
// „Éï„Ç£„É´„Çø
// ============================================================
function applyFilter() {
  currentFilter = {
    keyword: document.getElementById('filterKeyword').value,
    dateFrom: document.getElementById('filterDateFrom').value,
    dateTo: document.getElementById('filterDateTo').value,
    diameter: document.getElementById('filterDiameter').value,
    submitStatus: document.getElementById('filterStatus').value,
    hasAttachment: document.getElementById('filterAttachment').value ? 
      (document.getElementById('filterAttachment').value === 'true') : undefined
  };
  
  loadRecords();
}

function clearFilter() {
  document.getElementById('filterKeyword').value = '';
  document.getElementById('filterDateFrom').value = '';
  document.getElementById('filterDateTo').value = '';
  document.getElementById('filterDiameter').value = '';
  document.getElementById('filterStatus').value = '';
  document.getElementById('filterAttachment').value = '';
  
  currentFilter = {};
  loadRecords();
}

// ============================================================
// „É¢„Éº„ÉÄ„É´Êìç‰Ωú
// ============================================================
function showCreateModal() {
  document.getElementById('modalTitle').textContent = 'Êñ∞Ë¶èÁôªÈå≤';
  document.getElementById('recordForm').reset();
  document.getElementById('recordId').value = '';
  document.getElementById('attachType').value = '';
  toggleAttachMethod();
  
  // Âà∞ÁùÄÊó•„Å´‰ªäÊó•„Çí„Çª„ÉÉ„Éà
  document.getElementById('arrivalDate').value = new Date().toISOString().split('T')[0];
  
  document.getElementById('editModal').style.display = 'block';
}

function showEditModal(record) {
  document.getElementById('modalTitle').textContent = 'Á∑®ÈõÜ';
  document.getElementById('recordId').value = record.id;
  
  document.getElementById('arrivalDate').value = record.arrivalDate;
  document.getElementById('deliveryNo').value = record.deliveryNo;
  document.getElementById('contractNo').value = record.contractNo;
  document.getElementById('diameter').value = record.diameter;
  document.getElementById('strength').value = record.strength || '';
  document.getElementById('maker').value = record.maker || '';
  document.getElementById('quantity').value = record.quantity;
  document.getElementById('note').value = record.note || '';
  
  document.getElementById('millSentDate').value = record.millSentDate || '';
  document.getElementById('tagSentDate').value = record.tagSentDate || '';
  document.getElementById('pdfSentDate').value = record.pdfSentDate || '';
  document.getElementById('netSentDate').value = record.netSentDate || '';
  
  if (record.attachUrl) {
    document.getElementById('attachType').value = 'link';
    document.getElementById('attachUrl').value = record.attachUrl;
  } else if (record.attachFileId) {
    document.getElementById('attachType').value = 'upload';
  } else {
    document.getElementById('attachType').value = '';
  }
  
  toggleAttachMethod();
  
  document.getElementById('editModal').style.display = 'block';
}

function closeModal() {
  document.getElementById('editModal').style.display = 'none';
}

function toggleAttachMethod() {
  const type = document.getElementById('attachType').value;
  document.getElementById('uploadArea').style.display = type === 'upload' ? 'block' : 'none';
  document.getElementById('linkArea').style.display = type === 'link' ? 'block' : 'none';
}

// ============================================================
// ‰øùÂ≠ò
// ============================================================
function saveRecord() {
  const id = document.getElementById('recordId').value;
  const data = {
    arrivalDate: document.getElementById('arrivalDate').value,
    deliveryNo: document.getElementById('deliveryNo').value,
    contractNo: document.getElementById('contractNo').value,
    diameter: document.getElementById('diameter').value,
    strength: document.getElementById('strength').value,
    maker: document.getElementById('maker').value,
    quantity: document.getElementById('quantity').value,
    note: document.getElementById('note').value,
    millSentDate: document.getElementById('millSentDate').value,
    tagSentDate: document.getElementById('tagSentDate').value,
    pdfSentDate: document.getElementById('pdfSentDate').value,
    netSentDate: document.getElementById('netSentDate').value,
    attachType: document.getElementById('attachType').value,
    attachUrl: document.getElementById('attachUrl').value
  };
  
  // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
  if (!data.arrivalDate || !data.deliveryNo || !data.contractNo || 
      !data.diameter || !data.quantity) {
    alert('ÂøÖÈ†àÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  
  if (parseFloat(data.quantity) <= 0) {
    alert('Êï∞Èáè„ÅØ0„Çà„ÇäÂ§ß„Åç„ÅÑÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  
  showLoading();
  
  // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
  const attachType = document.getElementById('attachType').value;
  if (attachType === 'upload') {
    const fileInput = document.getElementById('attachFile');
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const base64Data = e.target.result.split(',')[1];
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              data.attachFileId = result.fileId;
              data.attachUrl = result.url;
              saveRecordToServer(id, data);
            } else {
              alert('„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº: ' + result.error);
              hideLoading();
            }
          })
          .uploadAttachment(base64Data, file.name, file.type);
      };
      
      reader.readAsDataURL(file);
    } else {
      saveRecordToServer(id, data);
    }
  } else {
    saveRecordToServer(id, data);
  }
}

function saveRecordToServer(id, data) {
  const method = id ? 'updateRecord' : 'createRecord';
  const args = id ? [id, data] : [data];
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        closeModal();
        loadRecords();
        alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
      } else {
        alert('‰øùÂ≠ò„Ç®„É©„Éº: ' + result.error);
      }
      hideLoading();
    })
    .withFailureHandler(function(error) {
      alert('‰øùÂ≠ò„Ç®„É©„Éº: ' + error);
      hideLoading();
    })
    [method](...args);
}

// ============================================================
// ÂâäÈô§
// ============================================================
function deleteRecord(id) {
  if (!confirm('Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„Åã?')) {
    return;
  }
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        loadRecords();
        alert('ÂâäÈô§„Åó„Åæ„Åó„Åü');
      } else {
        alert('ÂâäÈô§„Ç®„É©„Éº: ' + result.error);
      }
      hideLoading();
    })
    .deleteRecord(id);
}

// ============================================================
// ÊèêÂá∫ÁÆ°ÁêÜ
// ============================================================
function markAsSubmitted(id) {
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        loadRecords();
      } else {
        alert('„Ç®„É©„Éº: ' + result.error);
      }
      hideLoading();
    })
    .markAsSubmitted(id);
}

function markAsUnsubmitted(id) {
  if (!confirm('Êú™ÊèêÂá∫„Å´Êàª„Åó„Åæ„Åô„Åã?')) {
    return;
  }
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(result) {
      if (result.success) {
        loadRecords();
      } else {
        alert('„Ç®„É©„Éº: ' + result.error);
      }
      hideLoading();
    })
    .markAsUnsubmitted(id);
}

// ============================================================
// CSVÂá∫Âäõ
// ============================================================
function exportCSV() {
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(csv) {
      downloadCSV(csv, 'millsheet_list.csv');
      hideLoading();
    })
    .exportToCSV(currentFilter);
}

function showMonthlySummary() {
  document.getElementById('summaryModal').style.display = 'block';
}

function closeSummaryModal() {
  document.getElementById('summaryModal').style.display = 'none';
}

function downloadMonthlySummary() {
  const year = document.getElementById('summaryYear').value;
  const month = document.getElementById('summaryMonth').value;
  
  showLoading();
  
  google.script.run
    .withSuccessHandler(function(csv) {
      downloadCSV(csv, `millsheet_summary_${year}${month.padStart(2, '0')}.csv`);
      hideLoading();
      closeSummaryModal();
    })
    .exportMonthlySummary(parseInt(year), parseInt(month));
}

function downloadCSV(csv, filename) {
  const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
  const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.display = 'none';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ============================================================
// UI „Éò„É´„Éë„Éº
// ============================================================
function showLoading() {
  document.getElementById('loading').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loading').style.display = 'none';
}

// „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
window.onclick = function(event) {
  const editModal = document.getElementById('editModal');
  const summaryModal = document.getElementById('summaryModal');
  
  if (event.target === editModal) {
    closeModal();
  }
  if (event.target === summaryModal) {
    closeSummaryModal();
  }
}
</script>
